name: Build and Release

on:
    workflow_dispatch:
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: write

jobs:
    build-linux:
        runs-on: ubuntu-latest
        container:
            image: golang:1.25
        strategy:
            matrix:
                goarch: [amd64, arm64]

        steps:
            - name: Setup Build Environment
              run: |
                  set -e
                  apt-get update
                  if [ "${{ matrix.goarch }}" = "arm64" ]; then
                    dpkg --add-architecture arm64
                    apt-get update
                    apt-get install -y --no-install-recommends gcc-aarch64-linux-gnu libc6-dev-arm64-cross libpcap-dev:arm64
                  else
                    apt-get install -y --no-install-recommends build-essential libpcap-dev
                  fi

            - name: Checkout Code
              uses: actions/checkout@v5

            - name: Mark repo as safe
              run: git config --global --add safe.directory $GITHUB_WORKSPACE

            - name: Get tag or commit
              id: ref_id
              shell: bash
              run: |
                  if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
                    REF_ID="${GITHUB_REF#refs/tags/}"
                    echo "Triggered by tag: $REF_ID"
                  else
                    REF_ID=$(git rev-parse --short HEAD)
                    echo "No tag detected. Using commit hash: $REF_ID"
                  fi
                  echo "ref=$REF_ID" >> $GITHUB_OUTPUT

            - name: Build
              run: |
                  mkdir -p dist
                  export CGO_ENABLED=1 
                  export GOOS=linux 
                  export GOARCH=${{ matrix.goarch }}
                  export VERSION=${{ steps.ref_id.outputs.ref }}
                  export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
                  export GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
                  export BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

                  # Set the C compiler for cross-compilation
                  if [ "$GOARCH" = "arm64" ]; then
                    export CC=aarch64-linux-gnu-gcc
                  fi

                  go build -v -a -trimpath \
                    -ldflags "-s -w -buildid= \
                    -X 'paqet/cmd/version.Version=${VERSION}' \
                    -X 'paqet/cmd/version.GitCommit=${GIT_COMMIT}' \
                    -X 'paqet/cmd/version.GitTag=${GIT_TAG}' \
                    -X 'paqet/cmd/version.BuildTime=${BUILD_TIME}'" \
                    -o paqet_linux_${{ matrix.goarch }} ./cmd/main.go

                  chmod +x paqet_linux_${{ matrix.goarch }}
                  tar -czvf dist/paqet-linux-${{ matrix.goarch }}-${{ steps.ref_id.outputs.ref }}.tar.gz \
                    paqet_linux_${{ matrix.goarch }} \
                    README.md \
                    example/client.yaml.example \
                    example/server.yaml.example

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: paqet-linux-${{ matrix.goarch }}
                  path: dist/paqet-linux-${{ matrix.goarch }}-${{ steps.ref_id.outputs.ref }}.tar.gz
                  retention-days: 1

    build-windows:
        runs-on: windows-latest
        strategy:
            matrix:
                goarch: [amd64]
        steps:
            - name: Setup Build Environment
              run: |
                  # Install Npcap for libpcap support on Windows
                  choco install npcap -y
                  # Install MinGW for CGO support
                  choco install mingw -y

            - name: Checkout Code
              uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.25"

            - name: Get tag or commit
              id: ref_id
              shell: bash
              run: |
                  if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
                    REF_ID="${GITHUB_REF#refs/tags/}"
                    echo "Triggered by tag: $REF_ID"
                  else
                    REF_ID=$(git rev-parse --short HEAD)
                    echo "No tag detected. Using commit hash: $REF_ID"
                  fi
                  echo "ref=$REF_ID" >> $GITHUB_OUTPUT

            - name: Build
              shell: bash
              run: |
                  mkdir -p dist
                  export CGO_ENABLED=1 
                  export GOOS=windows 
                  export GOARCH=${{ matrix.goarch }}
                  export VERSION=${{ steps.ref_id.outputs.ref }}
                  export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
                  export GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
                  export BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

                  go build -v -a -trimpath \
                    -ldflags "-s -w -buildid= \
                    -X 'paqet/cmd/version.Version=${VERSION}' \
                    -X 'paqet/cmd/version.GitCommit=${GIT_COMMIT}' \
                    -X 'paqet/cmd/version.GitTag=${GIT_TAG}' \
                    -X 'paqet/cmd/version.BuildTime=${BUILD_TIME}'" \
                    -o paqet_windows_${{ matrix.goarch }}.exe ./cmd/main.go

                  7z a -tzip dist/paqet-windows-${{ matrix.goarch }}-${{ steps.ref_id.outputs.ref }}.zip \
                    paqet_windows_${{ matrix.goarch }}.exe \
                    README.md \
                    example/client.yaml.example \
                    example/server.yaml.example

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: paqet-windows-${{ matrix.goarch }}
                  path: dist/paqet-windows-${{ matrix.goarch }}-${{ steps.ref_id.outputs.ref }}.zip
                  retention-days: 1

    build-darwin:
        runs-on: macos-latest
        strategy:
            matrix:
                goarch: [amd64, arm64]
        steps:
            - name: Checkout Code
              uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.25"

            - name: Get tag or commit
              id: ref_id
              run: |
                  if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
                    REF_ID="${GITHUB_REF#refs/tags/}"
                    echo "Triggered by tag: $REF_ID"
                  else
                    REF_ID=$(git rev-parse --short HEAD)
                    echo "No tag detected. Using commit hash: $REF_ID"
                  fi
                  echo "ref=$REF_ID" >> $GITHUB_OUTPUT

            - name: Build
              run: |
                  mkdir -p dist
                  export CGO_ENABLED=1 
                  export GOOS=darwin 
                  export GOARCH=${{ matrix.goarch }}
                  export VERSION=${{ steps.ref_id.outputs.ref }}
                  export GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
                  export GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
                  export BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

                  go build -v -a -trimpath \
                    -ldflags "-s -w -buildid= \
                    -X 'paqet/cmd/version.Version=${VERSION}' \
                    -X 'paqet/cmd/version.GitCommit=${GIT_COMMIT}' \
                    -X 'paqet/cmd/version.GitTag=${GIT_TAG}' \
                    -X 'paqet/cmd/version.BuildTime=${BUILD_TIME}'" \
                    -o paqet_darwin_${{ matrix.goarch }} ./cmd/main.go

                  chmod +x paqet_darwin_${{ matrix.goarch }}
                  tar -czvf dist/paqet-darwin-${{ matrix.goarch }}-${{ steps.ref_id.outputs.ref }}.tar.gz \
                    paqet_darwin_${{ matrix.goarch }} \
                    README.md \
                    example/client.yaml.example \
                    example/server.yaml.example

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: paqet-darwin-${{ matrix.goarch }}
                  path: dist/paqet-darwin-${{ matrix.goarch }}-${{ steps.ref_id.outputs.ref }}.tar.gz
                  retention-days: 1

    build-android:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                abi: [arm64-v8a, armeabi-v7a]
        steps:
            - name: Checkout Code
              uses: actions/checkout@v5

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.25"

            - name: Install NDK and build deps
              run: |
                  sudo apt-get update
                  sudo apt-get install -y --no-install-recommends flex bison autoconf automake libtool wget unzip
                  wget -q https://dl.google.com/android/repository/android-ndk-r26-linux.zip -O ndk.zip
                  unzip -q ndk.zip
                  echo "ANDROID_NDK_HOME=$GITHUB_WORKSPACE/android-ndk-r26" >> $GITHUB_ENV

            - name: Get tag or commit
              id: ref_id
              run: |
                  if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
                    REF_ID="${GITHUB_REF#refs/tags/}"
                  else
                    REF_ID=$(git rev-parse --short HEAD)
                  fi
                  echo "ref=$REF_ID" >> $GITHUB_OUTPUT

            - name: Build libpcap for Android
              run: |
                  chmod +x scripts/build-libpcap-android.sh
                  ANDROID_NDK_HOME="$GITHUB_WORKSPACE/android-ndk-r26" ./scripts/build-libpcap-android.sh ${{ matrix.abi }}

            - name: Build paqet for Android
              run: |
                  REF_ID="${{ steps.ref_id.outputs.ref }}"
                  GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
                  GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
                  BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
                  ANDROID_NDK_HOME="$GITHUB_WORKSPACE/android-ndk-r26"
                  LIBPCAP_DIR="$GITHUB_WORKSPACE/build/android/libpcap/${{ matrix.abi }}"
                  OUT_DIR="$GITHUB_WORKSPACE/build/android"
                  mkdir -p "$OUT_DIR"
                  if [ "${{ matrix.abi }}" = "arm64-v8a" ]; then
                    export GOARCH=arm64
                    CC="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
                    OUT="$OUT_DIR/paqet_android_arm64"
                  else
                    export GOARCH=arm
                    export GOARM=7
                    CC="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang"
                    OUT="$OUT_DIR/paqet_android_arm"
                  fi
                  CGO_ENABLED=1 GOOS=android CC="$CC" \
                  CGO_CFLAGS="-I$LIBPCAP_DIR/include" \
                  CGO_LDFLAGS="-L$LIBPCAP_DIR/lib -lpcap" \
                  go build -trimpath \
                    -ldflags "-s -w -X 'paqet/cmd/version.Version=${REF_ID}' -X 'paqet/cmd/version.GitCommit=${GIT_COMMIT}' -X 'paqet/cmd/version.GitTag=${GIT_TAG}' -X 'paqet/cmd/version.BuildTime=${BUILD_TIME}'" \
                    -o "$OUT" ./cmd/main.go
                  chmod +x "$OUT"

            - name: Package and upload
              run: |
                  mkdir -p dist
                  OUT_DIR="$GITHUB_WORKSPACE/build/android"
                  if [ "${{ matrix.abi }}" = "arm64-v8a" ]; then
                    TARBALL="dist/paqet-android-arm64-${{ steps.ref_id.outputs.ref }}.tar.gz"
                    tar -czvf "$TARBALL" -C "$GITHUB_WORKSPACE" \
                      build/android/paqet_android_arm64 README.md docs/android.md example/client.yaml.example example/server.yaml.example
                  else
                    TARBALL="dist/paqet-android-arm-${{ steps.ref_id.outputs.ref }}.tar.gz"
                    tar -czvf "$TARBALL" -C "$GITHUB_WORKSPACE" \
                      build/android/paqet_android_arm README.md docs/android.md example/client.yaml.example example/server.yaml.example
                  fi
                  echo "TARBALL=$TARBALL" >> $GITHUB_ENV

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: paqet-android-${{ matrix.abi }}
                  path: ${{ env.TARBALL }}
                  retention-days: 1

    release:
        runs-on: ubuntu-latest
        needs: [build-linux, build-darwin, build-windows, build-android]
        if: startsWith(github.ref, 'refs/tags/')
        steps:
            - name: Download all build artifacts
              uses: actions/download-artifact@v4
              with:
                  path: ./dist
                  pattern: paqet-*
                  merge-multiple: true

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  files: dist/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
